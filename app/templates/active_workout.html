{% extends "base.html" %}
{% block title %}Workout - Workout Tracker{% endblock %}

{% block body %}
<div class="container" style="padding-bottom: 140px;">
    <div class="page-header">
        <button class="back-btn" onclick="confirmExit()">‹ Back</button>
        <div style="flex: 1; display: flex; justify-content: center;">
            <select id="workout-selector" class="form-control" style="max-width: 200px; padding: 6px 10px; font-size: 0.95rem; font-weight: 600;" onchange="changeWorkout(this.value)">
                <option value="">Select workout...</option>
            </select>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('workout', this)">Workout</button>
    </div>

    <div id="exercises-container"></div>

    <div class="card mt-4">
        <div class="form-group" style="margin-bottom: 0;">
            <label>Body Weight (lb)</label>
            <input type="number" id="body-weight" class="form-control" step="0.1" placeholder="Optional">
        </div>
    </div>

    <div class="card mt-2">
        <div class="form-group" style="margin-bottom: 0;">
            <label>Notes</label>
            <textarea id="notes" class="form-control" rows="2" placeholder="Optional workout notes"></textarea>
        </div>
    </div>
</div>

<div class="timer-bar">
    <button class="btn btn-success" onclick="finishWorkout()" style="margin-left: auto;">Finish Workout</button>
</div>

<nav class="bottom-nav">
    <a class="nav-item active" href="/">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        Home
    </a>
</nav>
{% endblock %}

{% block scripts %}
<script>
const logId = {{ log_id }};
let logData = null;
let allWorkouts = [];

async function loadLog() {
    logData = await api.get(`/api/logs/${logId}`);

    // Load program to get ordered workouts
    if (logData.program_id) {
        const program = await api.get(`/api/programs/${logData.program_id}`);
        allWorkouts = (program.workouts || []).map(w => ({ id: w.id, name: w.name }));
    } else {
        // Fallback to all workouts if not part of a program
        allWorkouts = await api.get('/api/workouts');
    }
    populateWorkoutSelector();

    renderExercises();
}

function populateWorkoutSelector() {
    const selector = document.getElementById('workout-selector');
    selector.innerHTML = allWorkouts.map(w => `
        <option value="${w.id}" ${w.id === logData.workout_id ? 'selected' : ''}>${w.name}</option>
    `).join('');
}

async function changeWorkout(workoutId) {
    if (!workoutId || parseInt(workoutId) === logData.workout_id) return;

    try {
        const newWorkoutId = parseInt(workoutId);

        // Warn if there are completed sets
        const completedSets = logData.sets.filter(s => s.completed);
        if (completedSets.length > 0) {
            if (!await showConfirm(`You have ${completedSets.length} completed set(s). Switching workouts will clear your progress. Continue?`, 'Switch', 'btn-primary')) {
                populateWorkoutSelector(); // Revert selector
                return;
            }
        }

        // Update the log's workout
        const updated = await api.put(`/api/logs/${logId}`, { workout_id: newWorkoutId });

        // Update local data and re-render
        logData = updated;
        renderExercises();
        showToast('Workout changed', 'success');
    } catch (err) {
        showToast(err.message, 'error');
        populateWorkoutSelector(); // Revert selector
    }
}

function renderExercises() {
    const container = document.getElementById('exercises-container');
    container.innerHTML = '';

    // Group sets by exercise
    const exerciseMap = new Map();
    for (const set of logData.sets) {
        if (!exerciseMap.has(set.exercise_id)) {
            exerciseMap.set(set.exercise_id, {
                name: set.exercise_name,
                type: set.exercise_type,
                sets: [],
            });
        }
        exerciseMap.get(set.exercise_id).sets.push(set);
    }

    for (const [exId, ex] of exerciseMap) {
        const block = document.createElement('div');
        block.className = 'exercise-block';

        if (ex.type === 'cardio') {
            const set = ex.sets[0];
            block.innerHTML = `
                <div class="exercise-block-header">
                    <h3>${ex.name}</h3>
                    <span class="detail">Cardio</span>
                </div>
                <div class="cardio-input">
                    <input type="number" class="form-control" value="${set.duration_minutes || 30}"
                           style="width: 80px; text-align: center;"
                           onchange="updateCardioSet(${set.id}, this.value)">
                    <span class="text-muted">minutes</span>
                    <div class="set-circle ${set.completed ? 'completed' : ''}"
                         onclick="toggleCardioSet(${set.id}, this)"
                         style="margin-left: auto; width: 36px; height: 36px; font-size: 0.8rem;">
                        ${set.completed ? '✓' : '–'}
                    </div>
                </div>
            `;
        } else {
            const firstSet = ex.sets[0];
            const setsCount = ex.sets.length;
            const reps = firstSet.planned_reps;
            const weight = firstSet.weight;

            block.innerHTML = `
                <div class="exercise-block-header">
                    <h3>${ex.name}</h3>
                    <span class="detail">${setsCount}×${reps} ${weight ? weight + 'lb' : ''}</span>
                </div>
                <div class="sets-row">
                    ${ex.sets.map(set => {
                        let cls = '';
                        let display = set.planned_reps;
                        if (set.completed) {
                            if (set.actual_reps < set.planned_reps) {
                                cls = 'partial';
                                display = set.actual_reps;
                            } else {
                                cls = 'completed';
                                display = set.actual_reps;
                            }
                        }
                        return `<div class="set-circle ${cls}"
                                     onclick="toggleSet(${set.id}, ${set.planned_reps})"
                                     id="set-${set.id}">${display}</div>`;
                    }).join('')}
                </div>
            `;
        }

        container.appendChild(block);
    }
}

async function toggleSet(setId, plannedReps) {
    const set = logData.sets.find(s => s.id === setId);
    if (!set) return;

    if (!set.completed) {
        // First tap: mark complete with full reps
        set.completed = true;
        set.actual_reps = plannedReps;
    } else if (set.actual_reps > 0) {
        // Subsequent taps: decrement
        set.actual_reps--;
        if (set.actual_reps === 0) {
            // Reset to uncompleted
            set.completed = false;
            set.actual_reps = plannedReps;
        }
    }

    await api.put(`/api/logs/${logId}/sets/${setId}`, {
        completed: set.completed,
        actual_reps: set.actual_reps,
    });

    renderExercises();
}

async function toggleCardioSet(setId, el) {
    const set = logData.sets.find(s => s.id === setId);
    if (!set) return;
    set.completed = !set.completed;

    await api.put(`/api/logs/${logId}/sets/${setId}`, { completed: set.completed });
    renderExercises();
}

async function updateCardioSet(setId, minutes) {
    await api.put(`/api/logs/${logId}/sets/${setId}`, {
        duration_minutes: parseInt(minutes),
    });
}

function switchTab(tab, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
}

async function finishWorkout() {
    const notes = document.getElementById('notes').value.trim();
    const bw = document.getElementById('body-weight').value;

    const payload = { complete: true };
    if (notes) payload.notes = notes;
    if (bw) payload.body_weight = parseFloat(bw);

    await api.put(`/api/logs/${logId}`, payload);
    showToast('Workout complete!', 'success');
    setTimeout(() => window.location.href = '/', 1000);
}

async function confirmExit() {
    if (await showConfirm('Leave workout? Progress is saved.', 'Leave', 'btn-primary')) {
        window.location.href = '/';
    }
}

loadLog();
</script>
{% endblock %}
