{% extends "base.html" %}
{% block title %}History - Workout Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1>History</h1>
</div>

<div class="tabs">
    <button class="tab active" id="tab-list" onclick="switchTab('list')">List</button>
    <button class="tab" id="tab-calendar" onclick="switchTab('calendar')">Calendar</button>
</div>

<div id="list-view">
    <div id="history-list"></div>
</div>

<div id="calendar-view" class="hidden">
    <div class="calendar-nav">
        <button onclick="changeMonth(-1)">‹</button>
        <h3 id="calendar-title"></h3>
        <button onclick="changeMonth(1)">›</button>
    </div>
    <div class="calendar-grid">
        <div class="calendar-header">S</div>
        <div class="calendar-header">M</div>
        <div class="calendar-header">T</div>
        <div class="calendar-header">W</div>
        <div class="calendar-header">T</div>
        <div class="calendar-header">F</div>
        <div class="calendar-header">S</div>
    </div>
    <div class="calendar-grid" id="calendar-days"></div>
    <div id="day-detail" class="mt-4"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTab = 'list';
let calMonth, calYear;
let workoutDates = [];
let allLogs = [];

const now = new Date();
calMonth = now.getMonth() + 1;
calYear = now.getFullYear();

function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tab-list').classList.toggle('active', tab === 'list');
    document.getElementById('tab-calendar').classList.toggle('active', tab === 'calendar');
    document.getElementById('list-view').classList.toggle('hidden', tab !== 'list');
    document.getElementById('calendar-view').classList.toggle('hidden', tab !== 'calendar');

    if (tab === 'calendar') loadCalendar();
    else loadHistory();
}

async function loadHistory() {
    const logs = await api.get('/api/logs');
    allLogs = logs;
    const container = document.getElementById('history-list');

    if (!logs.length) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>No workouts yet</h3>
                <p>Complete a workout and it will show up here.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = logs.map(log => {
        // Group sets by exercise
        const exerciseMap = new Map();
        for (const s of (log.sets || [])) {
            if (!exerciseMap.has(s.exercise_id)) {
                exerciseMap.set(s.exercise_id, { name: s.exercise_name, type: s.exercise_type, sets: [] });
            }
            exerciseMap.get(s.exercise_id).sets.push(s);
        }

        const exerciseRows = Array.from(exerciseMap.values()).map(ex => {
            const exerciseId = ex.sets[0].exercise_id;
            if (ex.type === 'cardio') {
                const s = ex.sets[0];
                const result = s.completed ? `${s.duration_minutes} min` : 'Skipped';
                return `<div class="history-exercise" onclick="window.location.href='/exercises/${exerciseId}/progress'" style="cursor: pointer;">
                    <span class="name">${ex.name}</span>
                    <span class="${s.completed ? 'result' : 'skipped'}">${result}</span>
                </div>`;
            }

            const completedSets = ex.sets.filter(s => s.completed);
            if (!completedSets.length) {
                return `<div class="history-exercise" onclick="window.location.href='/exercises/${exerciseId}/progress'" style="cursor: pointer;">
                    <span class="name">${ex.name}</span>
                    <span class="skipped">Skipped</span>
                </div>`;
            }

            const weight = completedSets[0].weight;
            const repsStr = completedSets.map(s => s.actual_reps).join('/');
            return `<div class="history-exercise" onclick="window.location.href='/exercises/${exerciseId}/progress'" style="cursor: pointer;">
                <span class="name">${ex.name}</span>
                <span class="result">${repsStr} ${weight ? weight + 'lb' : ''}</span>
            </div>`;
        }).join('');

        return `
            <div class="history-entry">
                <div class="history-entry-header">
                    <h3>${log.workout_name}</h3>
                    <span class="date">${formatDate(log.started_at)}</span>
                </div>
                ${exerciseRows}
            </div>
        `;
    }).join('');
}

async function loadCalendar() {
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('calendar-title').textContent = `${months[calMonth - 1]} ${calYear}`;

    const data = await api.get(`/api/logs/calendar?month=${calMonth}&year=${calYear}`);
    workoutDates = data.workout_dates || [];

    renderCalendar();
}

function renderCalendar() {
    const grid = document.getElementById('calendar-days');
    const firstDay = new Date(calYear, calMonth - 1, 1).getDay();
    const daysInMonth = new Date(calYear, calMonth, 0).getDate();
    const today = new Date();

    let html = '';
    // Empty cells before first day
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day empty"></div>';
    }

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${calYear}-${String(calMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const isToday = today.getFullYear() === calYear && today.getMonth() + 1 === calMonth && today.getDate() === d;
        const hasWorkout = workoutDates.includes(dateStr);

        let cls = 'calendar-day';
        if (isToday) cls += ' today';
        if (hasWorkout) cls += ' has-workout';

        html += `<div class="${cls}" onclick="showDayDetail('${dateStr}')">${d}</div>`;
    }

    grid.innerHTML = html;
}

function changeMonth(delta) {
    calMonth += delta;
    if (calMonth > 12) { calMonth = 1; calYear++; }
    if (calMonth < 1) { calMonth = 12; calYear--; }
    loadCalendar();
}

async function showDayDetail(dateStr) {
    const container = document.getElementById('day-detail');
    // Filter logs for this date
    const dayLogs = allLogs.length ? allLogs.filter(l => l.started_at.startsWith(dateStr)) : [];

    if (!dayLogs.length) {
        // Fetch all logs and filter
        const logs = await api.get(`/api/logs?from=${dateStr}T00:00:00&to=${dateStr}T23:59:59`);
        if (!logs.length) {
            container.innerHTML = `<p class="text-muted text-center text-sm">No workout on ${formatDate(dateStr + 'T12:00:00')}</p>`;
            return;
        }
        renderDayLogs(container, logs, dateStr);
    } else {
        renderDayLogs(container, dayLogs, dateStr);
    }
}

function renderDayLogs(container, logs, dateStr) {
    container.innerHTML = logs.map(log => `
        <div class="history-entry">
            <div class="history-entry-header">
                <h3>${log.workout_name}</h3>
                <span class="date">${formatDate(log.started_at)}</span>
            </div>
        </div>
    `).join('');
}

loadHistory();
</script>
{% endblock %}
